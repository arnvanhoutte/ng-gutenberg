{"version":3,"sources":["@wordpress/components/src/sandbox/index.js"],"names":["Component","renderToString","createRef","withGlobalEvents","FocusableIframe","Sandbox","arguments","trySandbox","bind","checkMessageForResize","iframe","state","width","height","current","contentDocument","body","e","event","data","JSON","parse","contentWindow","source","action","oldWidth","oldHeight","setState","isFrameAccessible","getAttribute","observeAndResizeJS","style","htmlDoc","document","documentElement","lang","props","type","title","__html","styles","map","rules","i","html","scripts","src","iframeDocument","open","write","close","onFocus","Math","ceil","message"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\nimport { Component, renderToString, createRef } from '@wordpress/element';\nimport { withGlobalEvents } from '@wordpress/compose';\n\n/**\n * Internal dependencies\n */\nimport FocusableIframe from '../focusable-iframe';\n\nclass Sandbox extends Component {\n\tconstructor() {\n\t\tsuper( ...arguments );\n\n\t\tthis.trySandbox = this.trySandbox.bind( this );\n\t\tthis.checkMessageForResize = this.checkMessageForResize.bind( this );\n\n\t\tthis.iframe = createRef();\n\n\t\tthis.state = {\n\t\t\twidth: 0,\n\t\t\theight: 0,\n\t\t};\n\t}\n\n\tcomponentDidMount() {\n\t\tthis.trySandbox();\n\t}\n\n\tcomponentDidUpdate() {\n\t\tthis.trySandbox();\n\t}\n\n\tisFrameAccessible() {\n\t\ttry {\n\t\t\treturn !! this.iframe.current.contentDocument.body;\n\t\t} catch ( e ) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tcheckMessageForResize( event ) {\n\t\tconst iframe = this.iframe.current;\n\n\t\t// Attempt to parse the message data as JSON if passed as string\n\t\tlet data = event.data || {};\n\t\tif ( 'string' === typeof data ) {\n\t\t\ttry {\n\t\t\t\tdata = JSON.parse( data );\n\t\t\t} catch ( e ) {}\n\t\t}\n\n\t\t// Verify that the mounted element is the source of the message\n\t\tif ( ! iframe || iframe.contentWindow !== event.source ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Update the state only if the message is formatted as we expect, i.e.\n\t\t// as an object with a 'resize' action, width, and height\n\t\tconst { action, width, height } = data;\n\t\tconst { width: oldWidth, height: oldHeight } = this.state;\n\n\t\tif ( 'resize' === action && ( oldWidth !== width || oldHeight !== height ) ) {\n\t\t\tthis.setState( { width, height } );\n\t\t}\n\t}\n\n\ttrySandbox() {\n\t\tif ( ! this.isFrameAccessible() ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst body = this.iframe.current.contentDocument.body;\n\t\tif ( null !== body.getAttribute( 'data-resizable-iframe-connected' ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst observeAndResizeJS = `\n\t\t\t( function() {\n\t\t\t\tvar observer;\n\n\t\t\t\tif ( ! window.MutationObserver || ! document.body || ! window.parent ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tfunction sendResize() {\n\t\t\t\t\tvar clientBoundingRect = document.body.getBoundingClientRect();\n\n\t\t\t\t\twindow.parent.postMessage( {\n\t\t\t\t\t\taction: 'resize',\n\t\t\t\t\t\twidth: clientBoundingRect.width,\n\t\t\t\t\t\theight: clientBoundingRect.height,\n\t\t\t\t\t}, '*' );\n\t\t\t\t}\n\n\t\t\t\tobserver = new MutationObserver( sendResize );\n\t\t\t\tobserver.observe( document.body, {\n\t\t\t\t\tattributes: true,\n\t\t\t\t\tattributeOldValue: false,\n\t\t\t\t\tcharacterData: true,\n\t\t\t\t\tcharacterDataOldValue: false,\n\t\t\t\t\tchildList: true,\n\t\t\t\t\tsubtree: true\n\t\t\t\t} );\n\n\t\t\t\twindow.addEventListener( 'load', sendResize, true );\n\n\t\t\t\t// Hack: Remove viewport unit styles, as these are relative\n\t\t\t\t// the iframe root and interfere with our mechanism for\n\t\t\t\t// determining the unconstrained page bounds.\n\t\t\t\tfunction removeViewportStyles( ruleOrNode ) {\n\t\t\t\t\tif( ruleOrNode.style ) {\n\t\t\t\t\t\t[ 'width', 'height', 'minHeight', 'maxHeight' ].forEach( function( style ) {\n\t\t\t\t\t\t\tif ( /^\\\\d+(vmin|vmax|vh|vw)$/.test( ruleOrNode.style[ style ] ) ) {\n\t\t\t\t\t\t\t\truleOrNode.style[ style ] = '';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} );\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tArray.prototype.forEach.call( document.querySelectorAll( '[style]' ), removeViewportStyles );\n\t\t\t\tArray.prototype.forEach.call( document.styleSheets, function( stylesheet ) {\n\t\t\t\t\tArray.prototype.forEach.call( stylesheet.cssRules || stylesheet.rules, removeViewportStyles );\n\t\t\t\t} );\n\n\t\t\t\tdocument.body.style.position = 'absolute';\n\t\t\t\tdocument.body.style.width = '100%';\n\t\t\t\tdocument.body.setAttribute( 'data-resizable-iframe-connected', '' );\n\n\t\t\t\tsendResize();\n\n\t\t\t\t// Resize events can change the width of elements with 100% width, but we don't\n\t\t\t\t// get an DOM mutations for that, so do the resize when the window is resized, too.\n\t\t\t\twindow.addEventListener( 'resize', sendResize, true );\n\t\t} )();`;\n\n\t\tconst style = `\n\t\t\tbody {\n\t\t\t\tmargin: 0;\n\t\t\t}\n\t\t\thtml,\n\t\t\tbody,\n\t\t\tbody > div,\n\t\t\tbody > div > iframe {\n\t\t\t\twidth: 100%;\n\t\t\t}\n\t\t\thtml.wp-has-aspect-ratio,\n\t\t\tbody.wp-has-aspect-ratio,\n\t\t\tbody.wp-has-aspect-ratio > div,\n\t\t\tbody.wp-has-aspect-ratio > div > iframe {\n\t\t\t\theight: 100%;\n\t\t\t\toverflow: hidden; /* If it has an aspect ratio, it shouldn't scroll. */\n\t\t\t}\n\t\t\tbody > div > * {\n\t\t\t\tmargin-top: 0 !important; /* Has to have !important to override inline styles. */\n\t\t\t\tmargin-bottom: 0 !important;\n\t\t\t}\n\t\t`;\n\n\t\t// put the html snippet into a html document, and then write it to the iframe's document\n\t\t// we can use this in the future to inject custom styles or scripts.\n\t\t// Scripts go into the body rather than the head, to support embedded content such as Instagram\n\t\t// that expect the scripts to be part of the body.\n\t\tconst htmlDoc = (\n\t\t\t<html lang={ document.documentElement.lang } className={ this.props.type }>\n\t\t\t\t<head>\n\t\t\t\t\t<title>{ this.props.title }</title>\n\t\t\t\t\t<style dangerouslySetInnerHTML={ { __html: style } } />\n\t\t\t\t\t{ ( this.props.styles && this.props.styles.map(\n\t\t\t\t\t\t( rules, i ) => <style key={ i } dangerouslySetInnerHTML={ { __html: rules } } />\n\t\t\t\t\t) ) }\n\t\t\t\t</head>\n\t\t\t\t<body data-resizable-iframe-connected=\"data-resizable-iframe-connected\" className={ this.props.type }>\n\t\t\t\t\t<div dangerouslySetInnerHTML={ { __html: this.props.html } } />\n\t\t\t\t\t<script type=\"text/javascript\" dangerouslySetInnerHTML={ { __html: observeAndResizeJS } } />\n\t\t\t\t\t{ ( this.props.scripts && this.props.scripts.map(\n\t\t\t\t\t\t( src ) => <script key={ src } src={ src } />\n\t\t\t\t\t) ) }\n\t\t\t\t</body>\n\t\t\t</html>\n\t\t);\n\n\t\t// writing the document like this makes it act in the same way as if it was\n\t\t// loaded over the network, so DOM creation and mutation, script execution, etc.\n\t\t// all work as expected\n\t\tconst iframeDocument = this.iframe.current.contentWindow.document;\n\t\tiframeDocument.open();\n\t\tiframeDocument.write( '<!DOCTYPE html>' + renderToString( htmlDoc ) );\n\t\tiframeDocument.close();\n\t}\n\n\tstatic get defaultProps() {\n\t\treturn {\n\t\t\thtml: '',\n\t\t\ttitle: '',\n\t\t};\n\t}\n\n\trender() {\n\t\tconst { title, onFocus } = this.props;\n\n\t\treturn (\n\t\t\t<FocusableIframe\n\t\t\t\tiframeRef={ this.iframe }\n\t\t\t\ttitle={ title }\n\t\t\t\tclassName=\"components-sandbox\"\n\t\t\t\tsandbox=\"allow-scripts allow-same-origin allow-presentation\"\n\t\t\t\tonLoad={ this.trySandbox }\n\t\t\t\tonFocus={ onFocus }\n\t\t\t\twidth={ Math.ceil( this.state.width ) }\n\t\t\t\theight={ Math.ceil( this.state.height ) } />\n\t\t);\n\t}\n}\n\nSandbox = withGlobalEvents( {\n\tmessage: 'checkMessageForResize',\n} )( Sandbox );\n\nexport default Sandbox;\n"]}